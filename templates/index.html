{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block header_title %}{{ header_title }}{% endblock %}

{% block head_extra %}
    <!-- Markdown Converter -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>

    <!-- MathJax Configuration -->
    <script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true,
            packages: ['base', 'ams', 'noerrors', 'noundefined']
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            processHtmlClass: 'tex2jax_process',
            ignoreHtmlClass: 'tex2jax_ignore'
        },
        loader: {
            load: ['[tex]/ams']
        }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <!-- highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* Styles for the file upload message, copied from history.html context */
        .system-message-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .system-message-container summary {
            cursor: pointer;
        }
        .history-sender.system-sender {
            color: #64748b;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .file-context-content {
            background: var(--background);
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            margin-top: 0.75rem;
        }
        .file-context-content strong {
            display: block;
            margin-bottom: 0.5rem;
        }
    </style>
{% endblock %}

{% block header_nav %}
        <div class="model-selector-wrapper">
        <label for="model-selector" class="visually-hidden">Model:</label>
        <select id="model-selector" class="model-selector">
            {% if available_models %}
                <optgroup label="Local Models">
                {% for model in available_models if model.active %}
                    <option value="{{ model.name }}" {% if model.name == model_id %}selected{% endif %}>{{ model.name }}</option>
                {% endfor %}
                </optgroup>
            {% else %}
                <option value="{{ model_id }}" selected>{{ model_id }} (default)</option>
            {% endif %}
            {% if cloud_models %}
                <optgroup label="Cloud Models">
                {% for model in cloud_models if model.active %}
                    <option value="cloud::{{ model.id }}">{{ model.service }} / {{ model.model_name }}</option>
                {% endfor %}
                </optgroup>
            {% endif %}
        </select>
    </div>
    <div class="model-selector-wrapper">
        <label for="prompt-selector" class="visually-hidden">Prompt:</label>
        <select id="prompt-selector" class="model-selector">
            <option value="" data-content="">ðŸš€ Select a Prompt...</option>
            {% for prompt in prompts %}
                <option value="{{ prompt.id }}" data-content="{{ prompt.content | e }}">
                    {{ prompt.title }}
                </option>
            {% endfor %}
        </select>
    </div>
    <button onclick="resetThread()" class="nav-link" title="New Chat">
        <span class="material-icons">add_comment</span>
    </button>
    <button id="incognito-toggle-btn" class="nav-link" title="Enable Incognito Mode">
        <span id="incognito-icon" class="material-icons">visibility</span>
    </button>
    <button id="search-button" class="nav-link" title="{% if searxng_enabled %}Web Search (type /search){% else %}Web Search disabled (Enable in Settings){% endif %}" {% if not searxng_enabled %}disabled{% endif %}>
        <span class="material-icons">search</span>
    </button>
    <button id="history-sidebar-toggle" class="nav-link" title="Toggle History Sidebar">
        <span class="material-icons">history</span>
    </button>
{% endblock %}

{% block content %}
    <div class="chat-area-container">
        <!-- Chat Box -->
        <div id="chatbox" class="page-content" style="padding: 0;"></div>
    </div>
{% endblock %}



{% block after_content %}
    <!-- Input Area -->
    <div class="input-area-wrapper">
        <div class="input-area">
            <input type="file" id="fileUpload" accept=".txt" title="Upload TXT File" style="display: none;" />
            <button id="uploadButton" class="nav-link" title="Upload TXT File"><span class="material-icons">attach_file</span></button>
            <textarea id="userMessage" placeholder="Type your message..." rows="1"></textarea>
            <button id="sendButton" class="send-button" title="Send"><span class="material-icons">send</span></button>
        </div>
        <footer class="footer" style="padding: 0.05rem 0 0 0; border: none;">
            <p>
                <a href="https://saisivarajuin.github.io/ai_think/" target="_blank" rel="noopener noreferrer">AI Think</a> - Your Local AI Companion
            </p>
            <p>AI can mess up.</p>
            <p>Made with ðŸ–¤</p>
        </footer>
    </div>
    <!-- Right Sidebar for History -->
    <aside class="history-sidebar">
        <div class="history-sidebar-header">
            <h4>Chat History</h4>
        </div>
        <div id="history-sidebar-content" class="history-sidebar-content">
            <!-- History items will be populated by JS -->
        </div>
    </aside>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}