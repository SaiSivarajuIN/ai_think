{% extends "base.html" %}

{% block title %}Settings | AI Think Chat{% endblock %}

{% block header_title %}{{ header_title }}{% endblock %}

{% block head_extra %}
    <style>
        .info-link {
            color: black;
            text-decoration: none;
        }
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        .tab-link {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--theme-toggle-text);
            font-size: 1rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-link.active, .tab-link:hover {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .settings-form {
            display: flex;
            flex-direction: column;
        }
        .settings-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .notes {
            font-size: 0.9rem;
            color: var(--text);
            background-color: var(--background);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
        }
        .notes h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text);
        }
        .notes p {
            margin-bottom: 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="tab-container">
        <button class="tab-link {% if active_tab == 'general' %}active{% endif %}" onclick="openTab(event, 'general')">General</button>
        <button class="tab-link {% if active_tab == 'integrations' %}active{% endif %}" onclick="openTab(event, 'integrations')">Integrations</button>
    </div>

    <form id="settings-form" class="settings-form" method="POST">
        <input type="hidden" name="active_tab" value="{{ active_tab }}">
        <div id="general" class="tab-content {% if active_tab == 'general' %}active{% endif %}">
            <div class="settings-section">
                <div class="card">
                    <h2>Model Parameters</h2>
                    <p class="text-muted">Control the behavior of the AI models.</p>
                    <div class="form-group">
                        <label for="num_predict">Tokens to Predict</label>
                        <input type="number" id="num_predict" name="num_predict" value="{{ settings['num_predict'] }}" min="1" max="40960" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature</label>
                        <input type="number" id="temperature" name="temperature" value="{{ settings['temperature'] }}" min="0" max="2" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="top_k">Top K</label>
                        <input type="number" id="top_k" name="top_k" value="{{ settings['top_k'] }}" min="1" max="100" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="top_p">Top P</label>
                        <input type="number" id="top_p" name="top_p" value="{{ settings['top_p'] }}" min="0" max="1" step="0.01" required>
                    </div>
                </div>
                <div class="notes">
                    <h3>Note- Understanding Model Parameters</h3>
                    <dl style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <dt><strong>Tokens to Predict:</strong></dt>
                            <dd>Tokens are the pieces of text the model reads and generates (words, parts of words, or punctuation). This setting controls the maximum number of tokens the model can generate in a single response.
                            <br><br>Example: The sentence "Hello, world!" might be split into tokens like: <code>["Hello", ",", " world", "!"]</code>.
                            </dd>
                        </div>
                        <div>
                            <dt><strong>Temperature (0–2):</strong></dt>
                            <dd>Controls the randomness of the model's output.
                            <br>- A <strong>low value</strong> (e.g., 0.1) makes the output more focused and predictable.
                            <br>- A <strong>high value</strong> (e.g., 1.0) makes it more random and creative.
                            </dd>
                        </div>
                        <div>
                            <dt><strong>Top-K (1+):</strong></dt>
                            <dd>Selects the K most likely words and picks one randomly from them.
                            <br><br>Example: With K=3, from probabilities [cat: 0.5, dog: 0.3, bird: 0.1, fish: 0.05], it samples only from cat, dog, bird.</dd>
                        </div>
                        <div>
                            <dt><strong>Top-P (0–1):</strong></dt>
                            <dd>Selects the smallest group of words whose total probability exceeds P, then samples from them.
                            <br><br>Example: With P=0.9, from the same probabilities, it includes cat (0.5) + dog (0.3) + bird (0.1) = 0.9, and samples from these three (excluding fish)
                            </dd>
                        </div>
                    </dl>
                    <table border="1" cellspacing="0" cellpadding="6">
                        <thead>
                            <tr>
                                <th>Goal</th>
                                <th>Top-K</th>
                                <th>Top-P</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Accurate / focused answers</strong></td>
                                <td>20–50</td>
                                <td>0.8–0.9</td>
                                <td>Keeps the model on topic, less randomness.</td>
                            </tr>
                            <tr>
                                <td><strong>Creative writing / brainstorming</strong></td>
                                <td>50–100</td>
                                <td>0.9–0.95</td>
                                <td>Allows more variety and imagination.</td>
                            </tr>
                            <tr>
                                <td><strong>Very random / experimental text</strong></td>
                                <td>100–200</td>
                                <td>0.95–1.0</td>
                                <td>Output is unpredictable and diverse.</td>
                            </tr>
                            <tr>
                                <td><strong>Balanced / natural</strong> <em>(most common)</em></td>
                                <td>40–60</td>
                                <td>0.9</td>
                                <td>Feels fluent and human-like.</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>

        <div id="integrations" class="tab-content {% if active_tab == 'integrations' %}active{% endif %}">
            <div class="settings-section">
                <div class="card">
                    <h2>Langfuse Tracing (Optional)</h2>
                    <div class="form-group toggle-group">
                        <label for="langfuse_enabled">Enable Langfuse</label>
                        <label class="switch">
                            <input type="checkbox" id="langfuse_enabled" name="langfuse_enabled" {% if settings.get('langfuse_enabled') %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="langfuse_public_key">Public Key</label>
                        <input type="text" id="langfuse_public_key" name="langfuse_public_key" value="{{ settings['langfuse_public_key'] }}" placeholder="pk-lf-...">
                    </div>
                    <div class="form-group">
                        <label for="langfuse_secret_key">Secret Key</label>
                        <input type="password" id="langfuse_secret_key" name="langfuse_secret_key" value="{{ settings['langfuse_secret_key'] }}" placeholder="sk-lf-...">
                    </div>
                    <div class="form-group">
                        <label for="langfuse_host">Host</label>
                        <input type="url" id="langfuse_host" name="langfuse_host" value="{{ settings['langfuse_host'] }}" placeholder="https://cloud.langfuse.com">
                    </div>
                </div>
                <div class="card">
                    <h2>ChromaDB Cloud (Optional)</h2>
                    <div class="form-group toggle-group">
                        <label for="chromadb_enabled">Enable ChromaDB</label>
                        <label class="switch">
                            <input type="checkbox" id="chromadb_enabled" name="chromadb_enabled" {% if settings.get('chromadb_enabled') %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="chroma_api_key">API Key</label>
                        <input type="password" id="chroma_api_key" name="chroma_api_key" value="{{ settings.get('chroma_api_key', '') }}" placeholder="Enter your ChromaDB API key">
                    </div>
                    <div class="form-group">
                        <label for="chroma_tenant">Tenant</label>
                        <input type="text" id="chroma_tenant" name="chroma_tenant" value="{{ settings.get('chroma_tenant', '') }}" placeholder="default">
                    </div>
                    <div class="form-group">
                        <label for="chroma_database">Database</label>
                        <input type="text" id="chroma_database" name="chroma_database" value="{{ settings.get('chroma_database', '') }}" placeholder="default">
                    </div>
                </div>
                <div class="card">
                    <h2>SearXNG Integration (Optional)</h2>
                    <div class="form-group toggle-group">
                        <label for="searxng_enabled">Enable SearXNG</label>
                        <label class="switch">
                            <input type="checkbox" id="searxng_enabled" name="searxng_enabled" {% if settings.get('searxng_enabled') %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="searxng_url">SearXNG URL</label>
                        <input type="url" id="searxng_url" name="searxng_url" value="{{ settings.get('searxng_url', '') }}" placeholder="http://localhost:8080">
                    </div>
                    <p class="text-muted">
                        The default URL for a local SearXNG instance is 
                        <a href="http://localhost:8080" target="_blank"><code>localhost:8080</code></a>.
                    </p>

                </div>
            </div>
        </div>

        <button type="submit" class="save-btn">Save Settings</button>
    </form>
{% endblock %}

{% block page_scripts %}
    <script>
        function openTab(evt, tabName) {
            // Update URL without reloading the page
            const baseUrl = "{{ url_for('settings') }}";
            const newUrl = tabName === 'general' ? baseUrl : `${baseUrl}/${tabName}`;
            window.history.pushState({path: newUrl}, '', newUrl);

            // Update the hidden input field with the current tab name
            document.querySelector('input[name="active_tab"]').value = tabName;

            // Hide all tab content
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            // Remove 'active' class from all tab links
            const tablinks = document.getElementsByClassName("tab-link");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            // Show the current tab and add an "active" class to the button that opened the tab
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Handle back/forward browser navigation
        window.addEventListener('popstate', function(event) {
            const path = window.location.pathname;
            const tabName = path.split('/').pop();
            const targetTab = (tabName === 'settings' || tabName === '') ? 'general' : tabName;
            // Find the button element to pass to openTab
            const tabButton = document.querySelector(`.tab-link[onclick*="'${targetTab}'"]`);
            if (tabButton) {
                // Directly call openTab, simulating an event object
                openTab({ currentTarget: tabButton }, targetTab);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
{% endblock %}