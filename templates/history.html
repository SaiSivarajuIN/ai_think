{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block header_title %}{{ header_title }}{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <!-- Add MathJax for LaTeX rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}


{% block content %}
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem;">
                    <button id="delete-all-threads-btn" class="icon-btn" title="Delete All Models" style="color: var(--disconnected); background: rgba(239, 68, 68, 0.1);">
                        <span class="material-icons">delete_sweep</span>
                        Delete All
                    </button>
                </div>
                {% if threads %}
                    {% for thread in threads %}
                        <details class="thread" {% if thread.session_id == newest_session_id %}open{% endif %}>
                            <summary>
                                <div class="summary-main" data-timestamp="{{ session_start[thread.session_id].isoformat() }}">
                                    Chat Session {{ thread.serial_number }} <small class="session-id-display">{{ thread.session_id }}</small> &mdash; <span class="session-start-time"></span>
                                </div>
                                <div class="summary-actions">
                                    <button class="download-doc-btn icon-btn" data-session="{{ thread.session_id }}" title="Download DOC">
                                        <span class="material-icons">description</span>
                                    </button>
                                    <button class="delete-thread-btn icon-btn" data-session="{{ thread.session_id }}" title="Delete Thread">
                                        <span class="material-icons">delete_forever</span>
                                    </button>
                                    <span class="message-count">({{ thread.messages|length }} messages)</span>
                                </div>
                            </summary>
                            <div class="thread-messages" id="thread-{{ thread.session_id }}">
                                {% for msg in thread.messages %}
                                    {% if msg.sender == 'system' %}
                                        <div class="message-container system-message-container" data-message-id="{{ msg.id }}">
                                            <div class="history-meta">
                                                <span class="history-sender system-sender">
                                                    <span class="material-icons">description</span> File Context
                                                </span>
                                                <div class="history-actions">
                                                    <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                                </div>
                                            </div>
                                            <div class="history-content file-context-content">{{ msg.content }}</div>
                                        </div>
                                    {% else %}
                                        <div class="message-container" data-message-id="{{ msg.id }}">
                                            <div class="history-meta">
                                                <span class="history-sender {{ 'user-sender' if msg.sender == 'user' else 'assistant-sender' }}">
                                                    {{ 'ðŸ‘¤ You' if msg.sender == 'user' else 'ðŸ¤– Bot' }}
                                                </span>
                                                <div class="history-actions">
                                                    <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                                    <button class="delete-btn icon-btn" title="Delete Message"><span class="material-icons">delete</span></button>
                                                </div>
                                            </div>
                                            <div class="history-content">{{ msg.content }}</div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </details>
                    {% endfor %}
                {% else %}
                    <div class="card">
                        <p>No chat history found. Start a conversation to see your chat threads here.</p>
                    </div>
                {% endif %}
{% endblock %}

{% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const converter = new showdown.Converter({
            simplifiedAutoLink: true,
            strikethrough: true,
            tables: true,
            tasklists: true,
            disableForced4SpacesIndentedSublists: true,
            simpleLineBreaks: true,
            openLinksInNewWindow: true,
            emoji: true,
        });

        // Render markdown for assistant messages
        document.querySelectorAll('.message-container').forEach(function(container) {
            const senderSpan = container.querySelector('.assistant-sender'); // Only process bot messages for markdown
            const contentDiv = container.querySelector('.history-content');
            if (senderSpan && contentDiv) {
                // Unescape HTML to get raw markdown with <think> tags
                const tempEl = document.createElement('textarea');
                tempEl.innerHTML = contentDiv.innerHTML;
                const rawMarkdown = tempEl.value;

                const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
                if (thinkRegex.test(rawMarkdown)) {
                    thinkRegex.lastIndex = 0; // Reset regex
                    const thoughts = [];
                    const mainContent = rawMarkdown.replace(thinkRegex, (match, thoughtContent) => {
                        thoughts.push(thoughtContent.trim());
                        return ''; // Remove from main content
                    }).trim();

                    let newHtml = converter.makeHtml(mainContent);

                    thoughts.forEach(thought => {
                        if (thought) {
                            newHtml += `<div class="thought"><strong>Thought Process</strong><div>${converter.makeHtml(thought)}</div></div>`;
                        }
                    });
                    contentDiv.innerHTML = newHtml;
                } else {
                    contentDiv.innerHTML = converter.makeHtml(rawMarkdown);
                }
            } else if (container.querySelector('.user-sender') && contentDiv) {
                // Handle search results in user messages
                const tempEl = document.createElement('textarea');
                tempEl.innerHTML = contentDiv.innerHTML;
                const rawText = tempEl.value;

                const searchRegex = /^Based on the following web search results, please answer the user's question.\n\n--- SEARCH RESULTS ---\n([\s\S]*?)\n\n--- USER QUESTION ---\n([\s\S]*)$/;
                const match = rawText.match(searchRegex);

                if (match) {
                    const searchResults = match[1].trim();
                    const userQuestion = match[2].trim();

                    // Display the original question first
                    let newHtml = converter.makeHtml(userQuestion);

                    // Add the collapsible search results section
                    if (searchResults) {
                        // Using the 'thought' class for similar styling
                        newHtml += `<div class="thought"><strong>Search Results</strong><div><pre><code>${searchResults.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre></div></div>`;
                    }
                    contentDiv.innerHTML = newHtml;
                } else {
                    // It's a regular user message, just render as markdown
                    contentDiv.innerHTML = converter.makeHtml(rawText);
                }
            }
        });

        // Format file context messages
        document.querySelectorAll('.file-context-content').forEach(function(contentDiv) {
            const rawText = contentDiv.textContent;
            const parts = rawText.split('\n\n--- CONTENT ---\n');
            if (parts.length === 2) {
                const filenameLine = parts[0];
                const fileContent = parts[1];
                contentDiv.innerHTML =
                    `<strong>${filenameLine.replace('File uploaded: ', '')}</strong>` +
                    `<pre><code>${fileContent.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`;
            }
        });

        // Format session start times to local time
        document.querySelectorAll('.summary-main[data-timestamp]').forEach(function(summary) {
            const timestamp = summary.getAttribute('data-timestamp');
            const timeSpan = summary.querySelector('.session-start-time');
            if (timestamp && timeSpan) {
                const date = new Date(timestamp);
                timeSpan.textContent = date.toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });
        // Format individual message times
        document.querySelectorAll('.history-time').forEach(function(timeElement) {
            const timestamp = timeElement.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                // Format to "HH:MM:SS AM/PM" in user's locale
                timeElement.textContent = date.toLocaleTimeString(undefined, {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const messageId = this.closest('.message-container').getAttribute('data-message-id');
                if (messageId && !this.closest('.system-message-container')) { // Prevent deleting system messages
                    deleteMessage(messageId);
                }
            });
        });

        // Add event listeners for thread delete buttons
        document.querySelectorAll('.delete-thread-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent details from toggling
                const sessionId = this.getAttribute('data-session');
                deleteThread(sessionId);
            });
        });

        // Add handler for Delete All Threads button
        const deleteAllBtn = document.getElementById('delete-all-threads-btn');
        if (deleteAllBtn) {
            deleteAllBtn.addEventListener('click', async function(e) {
                if (!confirm('Are you sure you want to delete ALL chat sessions? This cannot be undone.')) return;

                deleteAllBtn.disabled = true;
                try {
                    const response = await fetch('/delete_all_threads', {
                        method: 'DELETE',
                    });

                    const data = await response.json().catch(() => ({}));
                    if (response.ok && data.success) {
                        // Remove all thread elements
                        document.querySelectorAll('.thread').forEach(thread => thread.remove());

                        // Show the "no chat history" card
                        const pageContent = document.querySelector('main.page-content');
                        if (pageContent) {
                            pageContent.innerHTML = '';
                            const card = document.createElement('div');
                            card.className = 'card';
                            card.innerHTML = '<p>No chat history found. Start a conversation to see your chat threads here.</p>';
                            pageContent.appendChild(card);
                        }
                    } else {
                        alert('Failed to delete all threads: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting all threads:', error);
                    alert('An error occurred while deleting all threads.');
                } finally {
                    deleteAllBtn.disabled = false;
                }
            });
        }
    });

    async function deleteMessage(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) {
            return;
        }

        try {
            const response = await fetch(`/delete_message/${messageId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            } else {
                alert('Failed to delete message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting message');
        }
    }

    async function deleteThread(sessionId) {
        if (!confirm(`Are you sure you want to delete this entire chat session (${sessionId})? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/delete_thread/${sessionId}`, {
                method: 'DELETE',
            });

            const data = await response.json();
            if (response.ok && data.success) {
                // Find the <details> element for the thread and remove it
                const threadElement = document.querySelector(`button[data-session="${sessionId}"]`).closest('.thread');
                if (threadElement) {
                    threadElement.remove();
                }
            } else {
                alert('Failed to delete thread: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the thread.');
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}