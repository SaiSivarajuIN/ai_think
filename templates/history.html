<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat History | Ollama Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <!-- Add MathJax for LaTeX rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="fixed-layout">
    <div class="page-container">
        <header class="header">
            <h1>ðŸ“š Chat History</h1>
            <div class="header-nav">
                <a href="/" class="nav-link" title="New Chat">
                    <span class="material-icons">chat</span>
                </a>
                <a href="/health" class="nav-link" title="System Health">
                    <span class="material-icons">health_and_safety</span>
                </a>
                <a href="/settings" class="nav-link" title="Settings">
                    <span class="material-icons">settings</span>
                </a>
                <a href="/models" class="nav-link" title="Models Hub">
                    <span class="material-icons">hub</span>
                </a>
                <a href="/prompts" class="nav-link" title="Prompt Hub">
                    <span class="material-icons">apps</span>
                </a>
            </div>
        </header>

        <main class="page-content">
            {% if threads %}
                {% for thread in threads %}
                    <details class="thread" {% if thread.session_id == newest_session_id %}open{% endif %}>
                        <summary>
                            <div class="summary-main" data-timestamp="{{ session_start[thread.session_id].isoformat() }}">
                                Chat Session {{ thread.serial_number }} <small class="session-id-display">{{ thread.session_id }}</small> &mdash; <span class="session-start-time"></span>
                            </div>
                            <div class="summary-actions">
                                <button class="download-pdf-btn icon-btn" data-session="{{ thread.session_id }}" title="Download PDF">
                                    <span class="material-icons">picture_as_pdf</span>
                                </button>
                                <button class="delete-thread-btn icon-btn" data-session="{{ thread.session_id }}" title="Delete Thread">
                                    <span class="material-icons">delete_forever</span>
                                </button>
                                <span class="message-count">({{ thread.messages|length }} messages)</span>
                            </div>
                        </summary>
                        <div class="thread-messages" id="thread-{{ thread.session_id }}">
                            {% for msg in thread.messages %}
                                {% if msg.sender == 'system' %}
                                    <div class="message-container system-message-container" data-message-id="{{ msg.id }}">
                                        <div class="history-meta">
                                            <span class="history-sender system-sender">
                                                <span class="material-icons">description</span> File Context
                                            </span>
                                            <div class="history-actions">
                                                <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                            </div>
                                        </div>
                                        <div class="history-content file-context-content">{{ msg.content }}</div>
                                    </div>
                                {% else %}
                                    <div class="message-container" data-message-id="{{ msg.id }}">
                                        <div class="history-meta">
                                            <span class="history-sender {{ 'user-sender' if msg.sender == 'user' else 'assistant-sender' }}">
                                                {{ 'ðŸ‘¤ You' if msg.sender == 'user' else 'ðŸ¤– Bot' }}
                                            </span>
                                            <div class="history-actions">
                                                <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                                <button class="delete-btn icon-btn" title="Delete Message"><span class="material-icons">delete</span></button>
                                            </div>
                                        </div>
                                        <div class="history-content">{{ msg.content }}</div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </details>
                {% endfor %}
            {% else %}
                <div class="card">
                    <p>No chat history found. Start a conversation to see your chat threads here.</p>
                </div>
            {% endif %}
        </main>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const converter = new showdown.Converter({
            simplifiedAutoLink: true,
            strikethrough: true,
            tables: true,
            tasklists: true,
            disableForced4SpacesIndentedSublists: true,
            simpleLineBreaks: true,
            openLinksInNewWindow: true,
            emoji: true,
        });

        // Render markdown for assistant messages
        document.querySelectorAll('.message-container').forEach(function(container) {
            const senderSpan = container.querySelector('.assistant-sender'); // Only process bot messages for markdown
            const contentDiv = container.querySelector('.history-content');
            if (senderSpan && contentDiv) {
                // Unescape HTML to get raw markdown with <think> tags
                const tempEl = document.createElement('textarea');
                tempEl.innerHTML = contentDiv.innerHTML;
                const rawMarkdown = tempEl.value;

                const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
                if (thinkRegex.test(rawMarkdown)) {
                    thinkRegex.lastIndex = 0; // Reset regex
                    const thoughts = [];
                    const mainContent = rawMarkdown.replace(thinkRegex, (match, thoughtContent) => {
                        thoughts.push(thoughtContent.trim());
                        return ''; // Remove from main content
                    }).trim();

                    let newHtml = converter.makeHtml(mainContent);

                    thoughts.forEach(thought => {
                        if (thought) {
                            newHtml += `<div class="thought"><strong>Thought Process</strong><div>${converter.makeHtml(thought)}</div></div>`;
                        }
                    });
                    contentDiv.innerHTML = newHtml;
                } else {
                    contentDiv.innerHTML = converter.makeHtml(rawMarkdown);
                }
            }
        });

        // Format file context messages
        document.querySelectorAll('.file-context-content').forEach(function(contentDiv) {
            const rawText = contentDiv.textContent;
            const parts = rawText.split('\n\n--- CONTENT ---\n');
            if (parts.length === 2) {
                const filenameLine = parts[0];
                const fileContent = parts[1];
                contentDiv.innerHTML = 
                    `<strong>${filenameLine.replace('File uploaded: ', '')}</strong>` +
                    `<pre><code>${fileContent.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>`;
            }
        });

        // Format session start times to local time
        document.querySelectorAll('.summary-main[data-timestamp]').forEach(function(summary) {
            const timestamp = summary.getAttribute('data-timestamp');
            const timeSpan = summary.querySelector('.session-start-time');
            if (timestamp && timeSpan) {
                const date = new Date(timestamp);
                timeSpan.textContent = date.toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });
        // Format individual message times
        document.querySelectorAll('.history-time').forEach(function(timeElement) {
            const timestamp = timeElement.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                // Format to "HH:MM:SS AM/PM" in user's locale
                timeElement.textContent = date.toLocaleTimeString(undefined, {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const messageId = this.closest('.message-container').getAttribute('data-message-id');
                if (messageId && !this.closest('.system-message-container')) { // Prevent deleting system messages
                    deleteMessage(messageId);
                }
            });
        });

        // Add event listeners for thread delete buttons
        document.querySelectorAll('.delete-thread-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent details from toggling
                const sessionId = this.getAttribute('data-session');
                deleteThread(sessionId);
            });
        });
    });

    async function deleteMessage(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) {
            return;
        }

        try {
            const response = await fetch(`/delete_message/${messageId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            } else {
                alert('Failed to delete message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting message');
        }
    }

    async function deleteThread(sessionId) {
        if (!confirm(`Are you sure you want to delete this entire chat session (${sessionId})? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/delete_thread/${sessionId}`, {
                method: 'DELETE',
            });

            const data = await response.json();
            if (response.ok && data.success) {
                // Find the <details> element for the thread and remove it
                const threadElement = document.querySelector(`button[data-session="${sessionId}"]`).closest('.thread');
                if (threadElement) {
                    threadElement.remove();
                }
            } else {
                alert('Failed to delete thread: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the thread.');
        }
    }
    </script>
    <!-- MathJax v3 for LaTeX math rendering -->
    <script>
    window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
    },
    options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code'],
    }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>


</body>
</html>
