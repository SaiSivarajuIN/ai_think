{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block header_title %}{{ header_title }}{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <!-- Add MathJax for LaTeX rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
{% endblock %}


{% block content %}
    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem;">
        <button id="delete-all-threads-btn" class="icon-btn" title="Delete All Models" style="color: var(--disconnected); background: rgba(239, 68, 68, 0.1);">
            <span class="material-icons">delete_sweep</span>
            Delete All
        </button>
    </div>
    {% if grouped_threads %}
        {% for group_name, threads in grouped_threads %}
            <h3 class="history-group-header">{{ group_name }}</h3>
            {% for thread in threads %}
                <details class="thread" {% if thread.session_id == newest_session_id %}open{% endif %}>
                    <summary>
                        <div class="summary-main" title="{{ thread.summary }}" data-timestamp="{{ session_start[thread.session_id].isoformat() }}">
                            Chat Session {{ thread.serial_number }} :
                            {{ thread.summary }} <small class="session-id-display">{{ thread.session_id }}</small>
                            &mdash; <span class="session-start-time"></span>
                        </div>
                        <div class="summary-actions">
                            <!--DOC download-doc-btn icon-btn-->
                            <button class="download-doc-btn icon-btn" data-session="{{ thread.session_id }}" title="Download DOC">
                                <span class="material-icons">description</span>
                            </button>
                            <button class="delete-thread-btn icon-btn" data-session="{{ thread.session_id }}" title="Delete Thread">
                                <span class="material-icons">delete_forever</span>
                            </button>
                            <span class="message-count">({{ thread.messages|length }} messages)</span>
                        </div>
                    </summary>
                    <div class="thread-messages" id="thread-{{ thread.session_id }}">
                        {% for msg in thread.messages %}
                            {% if msg.sender == 'system' %}
                                <details class="message-container system-message-container" data-message-id="{{ msg.id }}">
                                    <summary>
                                        <div class="history-meta" style="cursor: pointer;">
                                            <span class="history-sender system-sender">
                                                <span class="material-icons">description</span> File Uploaded
                                            </span>
                                            <div class="history-actions">
                                                <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                            </div>
                                        </div>
                                    </summary>
                                    <div class="history-content file-context-content">{{ msg.content }}</div>
                                </details>
                            {% else %}
                                <div class="message-container" data-message-id="{{ msg.id }}">
                                    <div class="history-meta">
                                        <span class="history-sender {{ 'user-sender' if msg.sender == 'user' else 'assistant-sender' }}">
                                            {{ 'ðŸ‘¤ You' if msg.sender == 'user' else 'ðŸ¤– Bot' }}
                                        </span>
                                        <div class="history-actions">
                                            <span class="history-time" data-timestamp="{{ msg.timestamp.isoformat() }}"></span>
                                            <button class="delete-btn icon-btn" title="Delete Message"><span class="material-icons">delete</span></button>
                                        </div>
                                    </div>
                                    <div class="history-content" data-raw-content="{{ msg.content | e }}">{{ msg.content }}</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </details>
            {% endfor %}
        {% endfor %}
    {% else %}
        <div class="card">
            <p>No chat history found. Start a conversation to see your chat threads here.</p>
        </div>
    {% endif %}

    {% if pagination and pagination.total_pages > 1 %}
    <div class="pagination-container" style="margin-top: 2.5rem;">
        <div class="d-flex justify-content-center mb-2">
            <span class="text-muted">
                Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total_threads]|min }} of {{ pagination.total_threads }} threads
            </span>
        </div>

        <nav aria-label="Chat history pagination" class="d-flex justify-content-center">
            <ul class="pagination">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('history', page=pagination.prev_num) }}" aria-label="Previous">
                    <span class="material-icons" style="font-size: 1.2rem; vertical-align: middle;">chevron_left</span>
                </a>
            </li>

            {% for page_num in range(1, pagination.total_pages + 1) %}
                {% if page_num %}
                    {% if pagination.page == page_num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('history', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('history', page=pagination.next_num) }}" aria-label="Next">
                    <span class="material-icons" style="font-size: 1.2rem; vertical-align: middle;">chevron_right</span>
                </a>
            </li>
            </ul>
        </nav>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const converter = new showdown.Converter({
            simplifiedAutoLink: true,
            strikethrough: true,
            tables: true,
            tasklists: true,
            disableForced4SpacesIndentedSublists: true,
            simpleLineBreaks: true,
            openLinksInNewWindow: true,
            emoji: true,
            sanitize: true // Prevent interpretation of raw HTML in Markdown
        });

        // Render markdown for assistant messages
        document.querySelectorAll('.message-container').forEach(function(container) {
            const senderSpan = container.querySelector('.assistant-sender'); // Only process bot messages for markdown
            const contentDiv = container.querySelector('.history-content');
            if (senderSpan && contentDiv) {
                // Read raw content from data attribute to avoid re-interpreting HTML
                const rawMarkdown = contentDiv.dataset.rawContent || contentDiv.textContent;

                const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
                if (thinkRegex.test(rawMarkdown)) {
                    thinkRegex.lastIndex = 0; // Reset regex
                    const thoughts = [];
                    const mainContent = rawMarkdown.replace(thinkRegex, (match, thoughtContent) => {
                        thoughts.push(thoughtContent.trim());
                        return ''; // Remove from main content
                    }).trim();

                    let newHtml = converter.makeHtml(mainContent);

                    thoughts.forEach(thought => {
                        if (thought) {
                            newHtml += `<div class="thought"><strong>Thought Process</strong><div>${converter.makeHtml(thought)}</div></div>`;
                        }
                    });
                    contentDiv.innerHTML = newHtml;
                } else {
                    contentDiv.innerHTML = converter.makeHtml(rawMarkdown);
                }
            } else if (container.querySelector('.user-sender') && contentDiv) {
                // Handle search results in user messages
                // Read raw content from data attribute
                const rawText = contentDiv.dataset.rawContent || contentDiv.textContent;

                const searchRegex = /^Based on the following web search results, please answer the user's question\.\n\n--- SEARCH RESULTS ---\n([\s\S]*?)\n\n--- USER QUESTION ---\n([\s\S]*)$/m;
                const fileContextRegex = /^Based on the content of the document '(.+?)' provided below, please answer the following question\.\n\n---\n\nDOCUMENT CONTENT:\n([\s\S]*?)\n\n---\n\nQUESTION:\n([\s\S]*)$/m;

                const searchMatch = rawText.match(searchRegex);
                const fileMatch = rawText.match(fileContextRegex);

                if (searchMatch) {
                    const searchResults = searchMatch[1].trim();
                    const userQuestion = searchMatch[2].trim();

                    // Display the original question first
                    let newHtml = converter.makeHtml(userQuestion);

                    // Add the collapsible search results section
                    if (searchResults) {
                        newHtml += `<div class="thought"><strong>Search Results</strong><div><pre><code>${escapeHtml(searchResults)}</code></pre></div></div>`;
                    }
                    contentDiv.innerHTML = newHtml;
                } else if (fileMatch) {
                    const filename = fileMatch[1].trim();
                    const fileContent = fileMatch[2].trim();
                    const userQuestion = fileMatch[3].trim();

                    // Display the user's question first
                    let newHtml = converter.makeHtml(userQuestion);

                    // Add a collapsible section for the file context
                    if (fileContent) {
                        newHtml += `<div class="thought"><strong>File Context: ${escapeHtml(filename)}</strong><div><pre><code>${escapeHtml(fileContent)}</code></pre></div></div>`;
                    }
                    contentDiv.innerHTML = newHtml;
                } else {
                    // It's a regular user message, just render as markdown
                    contentDiv.innerHTML = converter.makeHtml(rawText);
                }
            }
        });

        // Format file context messages
        document.querySelectorAll('.file-context-content').forEach(function(contentDiv) {
            const rawText = contentDiv.textContent;
            const parts = rawText.split('\n\n--- CONTENT ---\n');
            if (parts.length === 2) {
                const filenameLine = parts[0];
                const fileContent = parts[1];
                contentDiv.innerHTML =
                    `<strong>${filenameLine.replace('File uploaded: ', '')}</strong>` +
                    `<pre><code>${escapeHtml(fileContent)}</code></pre>`;
            }
        });

        // Format session start times to local time
        document.querySelectorAll('.summary-main[data-timestamp]').forEach(function(summary) {
            const timestamp = summary.getAttribute('data-timestamp');
            const timeSpan = summary.querySelector('.session-start-time');
            if (timestamp && timeSpan) {
                const date = new Date(timestamp);
                timeSpan.textContent = date.toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });
        // Format individual message times
        document.querySelectorAll('.history-time').forEach(function(timeElement) {
            const timestamp = timeElement.getAttribute('data-timestamp');
            if (timestamp) {
                const date = new Date(timestamp);
                // Format to "HH:MM:SS AM/PM" in user's locale
                timeElement.textContent = date.toLocaleTimeString(undefined, {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const messageId = this.closest('.message-container').getAttribute('data-message-id');
                if (messageId && !this.closest('.system-message-container')) { // Prevent deleting system messages
                    deleteMessage(messageId);
                }
            });
        });

        // Add event listeners for thread delete buttons
        document.querySelectorAll('.delete-thread-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent details from toggling
                const sessionId = this.getAttribute('data-session');
                deleteThread(sessionId);
            });
        });

        // Add handler for Delete All Threads button
        const deleteAllBtn = document.getElementById('delete-all-threads-btn');
        if (deleteAllBtn) {
            deleteAllBtn.addEventListener('click', async function(e) {
                if (!confirm('Are you sure you want to delete ALL chat sessions? This cannot be undone.')) return;

                deleteAllBtn.disabled = true;
                try {
                    const response = await fetch('/delete_all_threads', {
                        method: 'DELETE',
                    });

                    const data = await response.json().catch(() => ({}));
                    if (response.ok && data.success) {
                        // Remove all thread elements
                        document.querySelectorAll('.thread').forEach(thread => thread.remove());

                        // Show the "no chat history" card
                        const pageContent = document.querySelector('main.page-content');
                        if (pageContent) {
                            pageContent.innerHTML = '';
                            const card = document.createElement('div');
                            card.className = 'card';
                            card.innerHTML = '<p>No chat history found. Start a conversation to see your chat threads here.</p>';
                            pageContent.appendChild(card);
                        }
                    } else {
                        alert('Failed to delete all threads: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting all threads:', error);
                    alert('An error occurred while deleting all threads.');
                } finally {
                    deleteAllBtn.disabled = false;
                }
            });
        }
    });

    async function deleteMessage(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) {
            return;
        }

        try {
            const response = await fetch(`/delete_message/${messageId}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            } else {
                alert('Failed to delete message');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting message');
        }
    }

    async function deleteThread(sessionId) {
        if (!confirm(`Are you sure you want to delete this entire chat session (${sessionId})? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/delete_thread/${sessionId}`, {
                method: 'DELETE',
            });

            const data = await response.json();
            if (response.ok && data.success) {
                // Find the <details> element for the thread and remove it
                const threadElement = document.querySelector(`button[data-session="${sessionId}"]`).closest('.thread');
                if (threadElement) {
                    threadElement.remove();
                }
            } else {
                alert('Failed to delete thread: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the thread.');
        }
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}